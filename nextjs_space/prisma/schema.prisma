generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/fyndr/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(uuid())
  email                  String                  @unique
  password               String
  name                   String?
  role                   String                  @default("buyer") // "buyer" or "supplier"
  companyId              String
  company                Company                 @relation("CompanyUsers", fields: [companyId], references: [id])
  createdAt              DateTime                @default(now())
  isDemo                 Boolean                 @default(false)
  rfps                   RFP[]
  contacts               Contact[]
  supplierPortalAccess   SupplierContact?
  notifications          Notification[]
  notificationPreference NotificationPreference?
  activityLogs           ActivityLog[]
  timelineEventsCreated  RfpTimelineEvent[]
  
  // STEP 38B: Template editing relations
  templatesEdited       RfpTemplate[]           @relation("TemplateEditor")
  clauseLinksCreated    RfpTemplateClauseLink[]
  
  // STEP 40: Executive Summary relations
  executiveSummaries    ExecutiveSummaryDocument[]
  
  // STEP 41: Award Decision relations
  awardDecisions        RFP[]                   @relation("AwardDecisions")
  
  // STEP 47: Archive relations
  archivedRfps          RFP[]                   @relation("ArchivedRFPs")
  
  // STEP 53: Admin Settings
  lastLoginAt           DateTime?
  isActive              Boolean                 @default(true)
  preferences           Json?                   // User preferences and defaults
  
  // STEP 56: Company-Level RFP Master Template Library
  rfpTemplatesCreated      RFPTemplate[]        @relation("TemplateCreator")
  rfpTemplateVersionsCreated RFPTemplateVersion[]
  
  // STEP 57: Company-Level Master Requirements Library
  requirementBlocksCreated RequirementBlock[]   @relation("RequirementBlockCreator")
  requirementBlockVersionsCreated RequirementBlockVersion[]
}

model Company {
  id                String   @id @default(uuid())
  name              String
  description       String?
  createdAt         DateTime @default(now())
  isDemo            Boolean  @default(false)
  users             User[]   @relation("CompanyUsers")
  rfps              RFP[]
  
  // STEP 35: Portfolio Overview & Multi-RFP Insights
  portfolioSnapshot Json?    // Cached portfolio-wide metrics snapshot
  portfolioMeta     Json?    // Metadata about snapshot generation
  
  // STEP 53: Admin Settings
  logo                   String?  // Logo URL or storage path
  brandColor             String?  // Hex color for branding
  timezone               String?  // TZ database timezone (e.g., "America/New_York")
  fiscalYearStartMonth   Int?     // 1-12 (January-December)
  
  // STEP 56: Company-Level RFP Master Template Library
  rfpTemplates      RFPTemplate[]
  
  // STEP 57: Company-Level Master Requirements Library
  requirementBlocks RequirementBlock[]
}

model Supplier {
  id           String   @id @default(uuid())
  name         String
  contactEmail String?
  createdAt    DateTime @default(now())
  rfps         RFP[]
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum RFPStage {
  INTAKE
  QUALIFICATION
  DISCOVERY
  DRAFTING
  PRICING_LEGAL_REVIEW
  EXEC_REVIEW
  SUBMISSION
  DEBRIEF
  ARCHIVED
}

enum InvitationStatus {
  PENDING
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

model RFP {
  id               String    @id @default(uuid())
  title            String
  description      String?
  status           String    @default("draft")
  stage            RFPStage  @default(INTAKE)
  createdAt        DateTime  @default(now())
  dueDate          DateTime?
  submittedAt      DateTime?
  budget           Float?
  priority         Priority  @default(MEDIUM)
  internalNotes    String?
  stageEnteredAt   DateTime?
  enteredStageAt   DateTime? // NEW: Primary field for SLA tracking
  stageSlaDays     Int? // NEW: SLA duration for current stage
  stageAutoActions Json?

  // Opportunity Scoring (STEP 13)
  opportunityScore               Int?
  opportunityScoreBreakdown      Json?
  opportunityScoreUpdatedAt      DateTime?
  opportunityScoreSource         String?
  opportunityScoreOverrideReason String?

  // RFP Timeline & Milestones (STEP 14)
  askQuestionsStart DateTime?
  askQuestionsEnd   DateTime?
  submissionStart   DateTime?
  submissionEnd     DateTime?
  demoWindowStart   DateTime?
  demoWindowEnd     DateTime?
  awardDate         DateTime?
  notifications     Json?

  // Supplier Comparison AI Narrative & Report (STEP 19)
  comparisonNarrative Json?
  comparisonReportUrl String?

  // STEP 34: Executive Decision Briefs
  decisionBriefSnapshot Json?  // Cached decision brief content
  decisionBriefMeta     Json?  // Metadata about the brief

  // Demo Mode Flag (STEP 32)
  isDemo Boolean @default(false)

  // STEP 36: Timeline Orchestration Engine (pre-award)
  timelineConfig        Json?  // Buyer-defined timeline + automation rules
  timelineStateSnapshot Json?  // Cached current state + next events

  // STEP 38A: Core Template System
  templateId              String?      // Reference to applied template
  template                RfpTemplate? @relation(fields: [templateId], references: [id])
  appliedTemplateSnapshot Json?        // Snapshot of template structure when applied
  
  // STEP 38B: Applied Clauses
  appliedClausesSnapshot Json?  // Clauses injected into RFP at template application time

  // STEP 39: Requirement-Level Scoring Matrix
  scoringMatrixSnapshot Json?  // Cached scoring matrix with requirements vs suppliers

  // STEP 41: Award Recommendation & RFP Finalization
  awardedSupplierId     String?   // ID of the winning/recommended supplier
  awardStatus           String?   // "not_awarded" | "recommended" | "awarded" | "cancelled"
  awardDecidedAt        DateTime? // When the award decision was made
  awardDecidedByUserId  String?   // User who made the award decision
  awardDecidedBy        User?     @relation("AwardDecisions", fields: [awardDecidedByUserId], references: [id])
  awardSnapshot         Json?     // Frozen snapshot of award decision details
  awardNotes            String?   // Buyer's decision rationale and notes

  // STEP 47: RFP Archive and Compliance Pack (Pre-Award Closure)
  isArchived              Boolean   @default(false)
  archivedAt              DateTime?
  archivedByUserId        String?
  archivedBy              User?     @relation("ArchivedRFPs", fields: [archivedByUserId], references: [id])
  compliancePackSnapshot  Json?     // Full compliance pack snapshot

  // STEP 57: Company-Level Master Requirements Library
  requirementGroups       Json?     // Inserted requirements from library

  user                      User                       @relation(fields: [userId], references: [id])
  userId                    String
  company                   Company                    @relation(fields: [companyId], references: [id])
  companyId                 String
  supplier                  Supplier                   @relation(fields: [supplierId], references: [id])
  supplierId                String
  summaryShares             SummaryShare[]
  stageHistory              StageHistory[]
  stageTasks                StageTask[]
  supplierContacts          SupplierContact[]
  supplierResponses         SupplierResponse[]
  evaluationMatrix          EvaluationMatrix?
  supplierQuestions         SupplierQuestion[]
  supplierBroadcastMessages SupplierBroadcastMessage[]
  activityLogs              ActivityLog[]
  timelineEvents            RfpTimelineEvent[]
  executiveSummaries        ExecutiveSummaryDocument[]
  // Note: PostgreSQL full-text search implemented via case-insensitive contains queries

  @@index([title])
  @@index([status])
  @@index([stage])
  @@index([createdAt])
  @@index([userId])
}

model Contact {
  id        String         @id @default(uuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  email     String
  role      String?
  createdAt DateTime       @default(now())
  shares    SummaryShare[]

  @@index([userId])
}

model SummaryShare {
  id        String   @id @default(uuid())
  rfpId     String
  rfp       RFP      @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  email     String
  template  String
  sentAt    DateTime @default(now())

  @@index([rfpId])
  @@index([contactId])
}

model StageHistory {
  id             String    @id @default(uuid())
  rfpId          String
  oldStage       RFPStage?
  newStage       RFPStage
  changedBy      String?
  overrideReason String?
  createdAt      DateTime  @default(now())

  rfp RFP @relation(fields: [rfpId], references: [id], onDelete: Cascade)

  @@index([rfpId])
}

model StageTask {
  id          String    @id @default(uuid())
  rfpId       String
  stage       RFPStage
  title       String
  completed   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  rfp RFP @relation(fields: [rfpId], references: [id], onDelete: Cascade)

  @@index([rfpId])
  @@index([stage])
}

model RfpTimelineEvent {
  id          String   @id @default(cuid())
  rfpId       String
  rfp         RFP      @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  eventType   String   // e.g., "Q_AND_A_OPENED", "Q_AND_A_CLOSED", "SUBMISSIONS_LOCKED", "DEMO_WINDOW_OPENED", "AWARD_TARGET_REACHED"
  occurredAt  DateTime @default(now())
  payload     Json?
  createdById String?  // user that triggered or system
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([rfpId, occurredAt])
}

model SupplierContact {
  id                 String           @id @default(uuid())
  rfpId              String
  name               String
  email              String
  organization       String?
  invitedAt          DateTime?
  invitationStatus   InvitationStatus @default(PENDING)
  portalUserId       String?          @unique
  accessToken        String?
  accessTokenExpires DateTime?
  responses          Json?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Performance Scorecard Fields (STEP 30)
  totalRFPsParticipated    Int   @default(0)
  totalWins                Int   @default(0)
  totalLosses              Int   @default(0)
  avgScore                 Float?
  avgReadiness             Float?
  avgSubmissionSpeedDays   Float?
  avgPricingCompetitiveness Float?
  reliabilityIndex         Float?

  // Demo Mode Flag (STEP 32)
  isDemo Boolean @default(false)

  rfp               RFP                @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  portalUser        User?              @relation(fields: [portalUserId], references: [id], onDelete: SetNull)
  supplierResponse  SupplierResponse?
  supplierQuestions SupplierQuestion[]
  activityLogs      ActivityLog[]
  // Note: PostgreSQL full-text search implemented via case-insensitive contains queries

  @@index([rfpId])
  @@index([email, rfpId])
  @@index([email])
  @@index([name])
  @@index([organization])
  @@index([invitationStatus])
  @@index([avgScore])
  @@index([avgReadiness])
  @@index([reliabilityIndex])
}

enum SupplierResponseStatus {
  DRAFT
  SUBMITTED
}

enum AttachmentType {
  GENERAL
  PRICING_SHEET
  REQUIREMENTS_MATRIX
  PRESENTATION
  DEMO_RECORDING
  CONTRACT_DRAFT
  OTHER
}

model SupplierResponse {
  id                String                 @id @default(uuid())
  rfpId             String
  supplierContactId String                 @unique
  status            SupplierResponseStatus @default(DRAFT)
  submittedAt       DateTime?
  structuredAnswers Json?
  notesFromSupplier String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  // AI Extraction Fields (STEP 17)
  extractedPricing              Json?
  extractedRequirementsCoverage Json?
  extractedTechnicalClaims      Json?
  extractedAssumptions          Json?
  extractedRisks                Json?
  extractedDifferentiators      Json?
  extractedDemoSummary          Json?
  extractedFilesMetadata        Json?

  // Comparison Fields (STEP 18)
  comparisonScore      Int?
  comparisonBreakdown  Json?
  comparisonMatrixUsed Boolean?
  comparisonAIInsights Json?

  // Supplier Readiness Fields (STEP 20)
  complianceFindings          Json?
  diversityMetadata           Json?
  mandatoryRequirementsStatus Json?
  riskFlags                   Json?
  readinessIndicator          String?
  readinessRationale          String?

  // STEP 33: Readiness Detail View & Risk Analyzer
  readinessBreakdown   Json? // Structured breakdown by category
  complianceFlags      Json? // Compliance/policy red flags
  missingRequirements  Json? // Missing/incomplete requirements
  readinessInsights    Json? // AI-generated explanations

  // Performance Metrics (STEP 30)
  finalScore               Float?
  readinessScore           Float?
  pricingScore             Float?
  submissionSpeedDays      Int?
  requirementsCoverage     Float?

  // Demo Mode Flag (STEP 32)
  isDemo Boolean @default(false)

  // STEP 41: Award outcome status
  awardOutcomeStatus String? // "recommended" | "shortlisted" | "not_selected" | "declined"

  rfp             RFP                          @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  supplierContact SupplierContact              @relation(fields: [supplierContactId], references: [id], onDelete: Cascade)
  attachments     SupplierResponseAttachment[]
  activityLogs    ActivityLog[]

  @@unique([rfpId, supplierContactId])
  @@index([rfpId])
  @@index([supplierContactId])
  @@index([status])
  @@index([submittedAt])
  @@index([supplierContactId, submissionSpeedDays])
}

model EvaluationMatrix {
  id        String   @id @default(uuid())
  rfpId     String   @unique
  name      String
  criteria  Json // array of objects: { id, label, weight }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rfp RFP @relation(fields: [rfpId], references: [id], onDelete: Cascade)

  @@index([rfpId])
}

model SupplierResponseAttachment {
  id                 String         @id @default(uuid())
  supplierResponseId String
  fileName           String
  fileType           String
  fileSize           Int
  storageKey         String
  attachmentType     AttachmentType @default(GENERAL)
  description        String?
  createdAt          DateTime       @default(now())

  supplierResponse SupplierResponse @relation(fields: [supplierResponseId], references: [id], onDelete: Cascade)

  @@index([supplierResponseId])
}

// STEP 21: Supplier Q&A Dialogue System
enum QuestionStatus {
  PENDING
  ANSWERED
}

model SupplierQuestion {
  id                String         @id @default(cuid())
  rfpId             String
  supplierContactId String
  question          String
  answer            String?
  status            QuestionStatus @default(PENDING)
  askedAt           DateTime       @default(now())
  answeredAt        DateTime?
  isDemo            Boolean        @default(false)

  rfp             RFP             @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  supplierContact SupplierContact @relation(fields: [supplierContactId], references: [id], onDelete: Cascade)
  // Note: PostgreSQL full-text search implemented via case-insensitive contains queries

  @@index([rfpId])
  @@index([supplierContactId])
  @@index([status])
  @@index([askedAt])
}

model SupplierBroadcastMessage {
  id                 String   @id @default(cuid())
  rfpId              String
  message            String   @db.Text
  createdAt          DateTime @default(now())
  createdBy          String
  supplierVisibility Json?
  isDemo             Boolean  @default(false)

  rfp RFP @relation(fields: [rfpId], references: [id], onDelete: Cascade)

  @@index([rfpId])
}

// STEP 22: Notifications & Reminders Engine
model Notification {
  id                 String  @id @default(cuid())
  userId             String
  rfpId              String?
  supplierResponseId String?
  supplierContactId  String?

  type     String
  category String
  title    String
  message  String
  channel  String
  metadata Json?

  readAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([rfpId])
}

model NotificationPreference {
  id           String  @id @default(cuid())
  userId       String  @unique
  emailEnabled Boolean @default(true)
  inAppEnabled Boolean @default(true)

  // Buyer-specific toggles
  buyerRfpTimeline       Boolean @default(true)
  buyerSupplierResponses Boolean @default(true)
  buyerSupplierQuestions Boolean @default(true)
  buyerQABroadcasts      Boolean @default(true)
  buyerReadinessChanges  Boolean @default(true)

  // Supplier-specific toggles
  supplierQATimeline         Boolean @default(true)
  supplierSubmissionTimeline Boolean @default(true)
  supplierBroadcasts         Boolean @default(true)
  supplierResponseStatus     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// STEP 23: Activity Log & Audit Trail System
model ActivityLog {
  id String @id @default(cuid())

  rfpId              String?
  supplierResponseId String?
  supplierContactId  String?
  userId             String?
  actorRole          String // "BUYER" | "SUPPLIER" | "SYSTEM"

  eventType String // event name
  summary   String // short human-readable summary
  details   Json? // structured metadata
  ipAddress String?
  userAgent String?
  isDemo    Boolean @default(false)

  createdAt DateTime @default(now())

  rfp              RFP?              @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  supplierResponse SupplierResponse? @relation(fields: [supplierResponseId], references: [id], onDelete: Cascade)
  supplierContact  SupplierContact?  @relation(fields: [supplierContactId], references: [id], onDelete: Cascade)
  user             User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Note: PostgreSQL full-text search implemented via case-insensitive contains queries

  @@index([rfpId, createdAt])
  @@index([userId, createdAt])
  @@index([eventType])
  @@index([actorRole])
  @@index([createdAt])
}


// STEP 38A: RFP Template System
model RfpTemplateCategory {
  id          String        @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  templates   RfpTemplate[]
}

model RfpTemplate {
  id            String                @id @default(cuid())
  categoryId    String
  category      RfpTemplateCategory   @relation(fields: [categoryId], references: [id])
  title         String
  description   String?
  structureJson Json                  // Full RFP template structure with sections, subsections, questions
  version       Int                   @default(1)
  isActive      Boolean               @default(true)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  
  // STEP 38B: Template Editor & Versioning
  isEditable      Boolean               @default(true)
  lastEditedById  String?
  lastEditedBy    User?                 @relation("TemplateEditor", fields: [lastEditedById], references: [id])
  sectionsJson    Json?                 // Editable template structure
  clausesJson     Json?                 // Injected clauses cached for performance
  
  rfps            RFP[]                 // RFPs that used this template
  clauseLinks     RfpTemplateClauseLink[]
  
  @@index([categoryId])
  @@index([isActive])
  @@index([lastEditedById])
}

// STEP 38B: Clause Library System
model ClauseCategory {
  id          String          @id @default(cuid())
  name        String
  description String?
  order       Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  clauses     ClauseLibrary[]
  
  @@index([order])
}

model ClauseLibrary {
  id          String                    @id @default(cuid())
  categoryId  String
  category    ClauseCategory            @relation(fields: [categoryId], references: [id])
  title       String
  description String
  body        String                    @db.Text  // Clause text (can be long)
  isRequired  Boolean                   @default(false)
  clauseType  String                    // "legal" | "commercial" | "security" | "sow" | "other"
  order       Int                       @default(0)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  
  templateClauseLinks RfpTemplateClauseLink[]
  
  @@index([categoryId])
  @@index([clauseType])
  @@index([order])
}

model RfpTemplateClauseLink {
  id          String        @id @default(cuid())
  templateId  String
  template    RfpTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  clauseId    String
  clause      ClauseLibrary @relation(fields: [clauseId], references: [id], onDelete: Cascade)
  required    Boolean       @default(false)  // Allow template override
  insertedAt  DateTime      @default(now())
  createdById String?
  createdBy   User?         @relation(fields: [createdById], references: [id])
  
  @@unique([templateId, clauseId])
  @@index([templateId])
  @@index([clauseId])
  @@index([createdById])
}

// STEP 40: Executive Stakeholder Summary Workspace
model ExecutiveSummaryDocument {
  id              String   @id @default(cuid())
  rfpId           String
  rfp             RFP      @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  authorId        String
  author          User     @relation(fields: [authorId], references: [id])
  
  // Content fields
  title           String   @default("Executive Summary")
  content         String   @db.Text  // Rich text content in HTML or Markdown
  tone            String   @default("professional")  // professional | persuasive | analytical
  audience        String   @default("executive")     // executive | technical | procurement
  
  // Version tracking
  version         Int      @default(1)
  isOfficial      Boolean  @default(false)  // true if marked as "final/official"
  clonedFromId    String?  // if this is a clone
  
  // Auto-generated metadata
  generatedAt     DateTime?  // when AI-generated (null if manually created)
  autoSaveAt      DateTime?  // last autosave timestamp
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([rfpId])
  @@index([authorId])
  @@index([isOfficial])
}

// STEP 56: Company-Level RFP Master Template Library
model RFPTemplate {
  id                String   @id @default(cuid())
  name              String
  description       String?
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id])
  visibility        String   @default("company") // "company" | "private"
  category          String?
  defaultTimeline   Json?
  defaultSections   Json?
  createdByUserId   String
  createdBy         User     @relation("TemplateCreator", fields: [createdByUserId], references: [id])
  isDeleted         Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  versions          RFPTemplateVersion[]

  @@index([companyId])
  @@index([category])
}

model RFPTemplateVersion {
  id                String      @id @default(cuid())
  templateId        String
  template          RFPTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  versionNumber     Int
  contentJson       Json
  createdAt         DateTime    @default(now())
  createdByUserId   String
  createdBy         User        @relation(fields: [createdByUserId], references: [id])

  @@unique([templateId, versionNumber])
  @@index([templateId])
}

// STEP 57: Company-Level Master Requirements Library
model RequirementBlock {
  id                String   @id @default(cuid())
  companyId         String
  company           Company  @relation(fields: [companyId], references: [id])
  title             String
  category          String
  subcategory       String?
  contentJson       Json     // Structured: {question, mustHave, scoringType, weight, notes}
  visibility        String   @default("company") // "company" | "private"
  createdByUserId   String
  createdBy         User     @relation("RequirementBlockCreator", fields: [createdByUserId], references: [id])
  isArchived        Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  versions          RequirementBlockVersion[]

  @@index([companyId])
  @@index([category])
  @@index([isArchived])
}

model RequirementBlockVersion {
  id                  String            @id @default(cuid())
  requirementBlockId  String
  requirementBlock    RequirementBlock  @relation(fields: [requirementBlockId], references: [id], onDelete: Cascade)
  versionNumber       Int
  contentJson         Json
  createdAt           DateTime          @default(now())
  createdByUserId     String
  createdBy           User              @relation(fields: [createdByUserId], references: [id])

  @@unique([requirementBlockId, versionNumber])
  @@index([requirementBlockId])
}