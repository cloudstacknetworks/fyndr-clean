generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                  @id @default(uuid())
  email                  String                  @unique
  password               String
  name                   String?
  role                   String                  @default("buyer") // "buyer" or "supplier"
  createdAt              DateTime                @default(now())
  isDemo                 Boolean                 @default(false)
  rfps                   RFP[]
  contacts               Contact[]
  supplierPortalAccess   SupplierContact?
  notifications          Notification[]
  notificationPreference NotificationPreference?
  activityLogs           ActivityLog[]
  timelineEventsCreated  RfpTimelineEvent[]
}

model Company {
  id                String   @id @default(uuid())
  name              String
  description       String?
  createdAt         DateTime @default(now())
  isDemo            Boolean  @default(false)
  rfps              RFP[]
  
  // STEP 35: Portfolio Overview & Multi-RFP Insights
  portfolioSnapshot Json?    // Cached portfolio-wide metrics snapshot
  portfolioMeta     Json?    // Metadata about snapshot generation
}

model Supplier {
  id           String   @id @default(uuid())
  name         String
  contactEmail String?
  createdAt    DateTime @default(now())
  rfps         RFP[]
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum RFPStage {
  INTAKE
  QUALIFICATION
  DISCOVERY
  DRAFTING
  PRICING_LEGAL_REVIEW
  EXEC_REVIEW
  SUBMISSION
  DEBRIEF
  ARCHIVED
}

enum InvitationStatus {
  PENDING
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

model RFP {
  id               String    @id @default(uuid())
  title            String
  description      String?
  status           String    @default("draft")
  stage            RFPStage  @default(INTAKE)
  createdAt        DateTime  @default(now())
  dueDate          DateTime?
  submittedAt      DateTime?
  budget           Float?
  priority         Priority  @default(MEDIUM)
  internalNotes    String?
  stageEnteredAt   DateTime?
  enteredStageAt   DateTime? // NEW: Primary field for SLA tracking
  stageSlaDays     Int? // NEW: SLA duration for current stage
  stageAutoActions Json?

  // Opportunity Scoring (STEP 13)
  opportunityScore               Int?
  opportunityScoreBreakdown      Json?
  opportunityScoreUpdatedAt      DateTime?
  opportunityScoreSource         String?
  opportunityScoreOverrideReason String?

  // RFP Timeline & Milestones (STEP 14)
  askQuestionsStart DateTime?
  askQuestionsEnd   DateTime?
  submissionStart   DateTime?
  submissionEnd     DateTime?
  demoWindowStart   DateTime?
  demoWindowEnd     DateTime?
  awardDate         DateTime?
  notifications     Json?

  // Supplier Comparison AI Narrative & Report (STEP 19)
  comparisonNarrative Json?
  comparisonReportUrl String?

  // STEP 34: Executive Decision Briefs
  decisionBriefSnapshot Json?  // Cached decision brief content
  decisionBriefMeta     Json?  // Metadata about the brief

  // Demo Mode Flag (STEP 32)
  isDemo Boolean @default(false)

  // STEP 36: Timeline Orchestration Engine (pre-award)
  timelineConfig        Json?  // Buyer-defined timeline + automation rules
  timelineStateSnapshot Json?  // Cached current state + next events

  // STEP 38A: Core Template System
  templateId              String?      // Reference to applied template
  template                RfpTemplate? @relation(fields: [templateId], references: [id])
  appliedTemplateSnapshot Json?        // Snapshot of template structure when applied

  user                      User                       @relation(fields: [userId], references: [id])
  userId                    String
  company                   Company                    @relation(fields: [companyId], references: [id])
  companyId                 String
  supplier                  Supplier                   @relation(fields: [supplierId], references: [id])
  supplierId                String
  summaryShares             SummaryShare[]
  stageHistory              StageHistory[]
  stageTasks                StageTask[]
  supplierContacts          SupplierContact[]
  supplierResponses         SupplierResponse[]
  evaluationMatrix          EvaluationMatrix?
  supplierQuestions         SupplierQuestion[]
  supplierBroadcastMessages SupplierBroadcastMessage[]
  activityLogs              ActivityLog[]
  timelineEvents            RfpTimelineEvent[]
  // Note: PostgreSQL full-text search implemented via case-insensitive contains queries

  @@index([title])
  @@index([status])
  @@index([stage])
  @@index([createdAt])
  @@index([userId])
}

model Contact {
  id        String         @id @default(uuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  email     String
  role      String?
  createdAt DateTime       @default(now())
  shares    SummaryShare[]

  @@index([userId])
}

model SummaryShare {
  id        String   @id @default(uuid())
  rfpId     String
  rfp       RFP      @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  email     String
  template  String
  sentAt    DateTime @default(now())

  @@index([rfpId])
  @@index([contactId])
}

model StageHistory {
  id             String    @id @default(uuid())
  rfpId          String
  oldStage       RFPStage?
  newStage       RFPStage
  changedBy      String?
  overrideReason String?
  createdAt      DateTime  @default(now())

  rfp RFP @relation(fields: [rfpId], references: [id], onDelete: Cascade)

  @@index([rfpId])
}

model StageTask {
  id          String    @id @default(uuid())
  rfpId       String
  stage       RFPStage
  title       String
  completed   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  rfp RFP @relation(fields: [rfpId], references: [id], onDelete: Cascade)

  @@index([rfpId])
  @@index([stage])
}

model RfpTimelineEvent {
  id          String   @id @default(cuid())
  rfpId       String
  rfp         RFP      @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  eventType   String   // e.g., "Q_AND_A_OPENED", "Q_AND_A_CLOSED", "SUBMISSIONS_LOCKED", "DEMO_WINDOW_OPENED", "AWARD_TARGET_REACHED"
  occurredAt  DateTime @default(now())
  payload     Json?
  createdById String?  // user that triggered or system
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([rfpId, occurredAt])
}

model SupplierContact {
  id                 String           @id @default(uuid())
  rfpId              String
  name               String
  email              String
  organization       String?
  invitedAt          DateTime?
  invitationStatus   InvitationStatus @default(PENDING)
  portalUserId       String?          @unique
  accessToken        String?
  accessTokenExpires DateTime?
  responses          Json?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  // Performance Scorecard Fields (STEP 30)
  totalRFPsParticipated    Int   @default(0)
  totalWins                Int   @default(0)
  totalLosses              Int   @default(0)
  avgScore                 Float?
  avgReadiness             Float?
  avgSubmissionSpeedDays   Float?
  avgPricingCompetitiveness Float?
  reliabilityIndex         Float?

  // Demo Mode Flag (STEP 32)
  isDemo Boolean @default(false)

  rfp               RFP                @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  portalUser        User?              @relation(fields: [portalUserId], references: [id], onDelete: SetNull)
  supplierResponse  SupplierResponse?
  supplierQuestions SupplierQuestion[]
  activityLogs      ActivityLog[]
  // Note: PostgreSQL full-text search implemented via case-insensitive contains queries

  @@index([rfpId])
  @@index([email, rfpId])
  @@index([email])
  @@index([name])
  @@index([organization])
  @@index([invitationStatus])
  @@index([avgScore])
  @@index([avgReadiness])
  @@index([reliabilityIndex])
}

enum SupplierResponseStatus {
  DRAFT
  SUBMITTED
}

enum AttachmentType {
  GENERAL
  PRICING_SHEET
  REQUIREMENTS_MATRIX
  PRESENTATION
  DEMO_RECORDING
  CONTRACT_DRAFT
  OTHER
}

model SupplierResponse {
  id                String                 @id @default(uuid())
  rfpId             String
  supplierContactId String                 @unique
  status            SupplierResponseStatus @default(DRAFT)
  submittedAt       DateTime?
  structuredAnswers Json?
  notesFromSupplier String?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt

  // AI Extraction Fields (STEP 17)
  extractedPricing              Json?
  extractedRequirementsCoverage Json?
  extractedTechnicalClaims      Json?
  extractedAssumptions          Json?
  extractedRisks                Json?
  extractedDifferentiators      Json?
  extractedDemoSummary          Json?
  extractedFilesMetadata        Json?

  // Comparison Fields (STEP 18)
  comparisonScore      Int?
  comparisonBreakdown  Json?
  comparisonMatrixUsed Boolean?
  comparisonAIInsights Json?

  // Supplier Readiness Fields (STEP 20)
  complianceFindings          Json?
  diversityMetadata           Json?
  mandatoryRequirementsStatus Json?
  riskFlags                   Json?
  readinessIndicator          String?
  readinessRationale          String?

  // STEP 33: Readiness Detail View & Risk Analyzer
  readinessBreakdown   Json? // Structured breakdown by category
  complianceFlags      Json? // Compliance/policy red flags
  missingRequirements  Json? // Missing/incomplete requirements
  readinessInsights    Json? // AI-generated explanations

  // Performance Metrics (STEP 30)
  finalScore               Float?
  readinessScore           Float?
  pricingScore             Float?
  submissionSpeedDays      Int?
  requirementsCoverage     Float?

  // Demo Mode Flag (STEP 32)
  isDemo Boolean @default(false)

  rfp             RFP                          @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  supplierContact SupplierContact              @relation(fields: [supplierContactId], references: [id], onDelete: Cascade)
  attachments     SupplierResponseAttachment[]
  activityLogs    ActivityLog[]

  @@unique([rfpId, supplierContactId])
  @@index([rfpId])
  @@index([supplierContactId])
  @@index([status])
  @@index([submittedAt])
  @@index([supplierContactId, submissionSpeedDays])
}

model EvaluationMatrix {
  id        String   @id @default(uuid())
  rfpId     String   @unique
  name      String
  criteria  Json // array of objects: { id, label, weight }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rfp RFP @relation(fields: [rfpId], references: [id], onDelete: Cascade)

  @@index([rfpId])
}

model SupplierResponseAttachment {
  id                 String         @id @default(uuid())
  supplierResponseId String
  fileName           String
  fileType           String
  fileSize           Int
  storageKey         String
  attachmentType     AttachmentType @default(GENERAL)
  description        String?
  createdAt          DateTime       @default(now())

  supplierResponse SupplierResponse @relation(fields: [supplierResponseId], references: [id], onDelete: Cascade)

  @@index([supplierResponseId])
}

// STEP 21: Supplier Q&A Dialogue System
enum QuestionStatus {
  PENDING
  ANSWERED
}

model SupplierQuestion {
  id                String         @id @default(cuid())
  rfpId             String
  supplierContactId String
  question          String
  answer            String?
  status            QuestionStatus @default(PENDING)
  askedAt           DateTime       @default(now())
  answeredAt        DateTime?
  isDemo            Boolean        @default(false)

  rfp             RFP             @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  supplierContact SupplierContact @relation(fields: [supplierContactId], references: [id], onDelete: Cascade)
  // Note: PostgreSQL full-text search implemented via case-insensitive contains queries

  @@index([rfpId])
  @@index([supplierContactId])
  @@index([status])
  @@index([askedAt])
}

model SupplierBroadcastMessage {
  id                 String   @id @default(cuid())
  rfpId              String
  message            String   @db.Text
  createdAt          DateTime @default(now())
  createdBy          String
  supplierVisibility Json?
  isDemo             Boolean  @default(false)

  rfp RFP @relation(fields: [rfpId], references: [id], onDelete: Cascade)

  @@index([rfpId])
}

// STEP 22: Notifications & Reminders Engine
model Notification {
  id                 String  @id @default(cuid())
  userId             String
  rfpId              String?
  supplierResponseId String?
  supplierContactId  String?

  type     String
  category String
  title    String
  message  String
  channel  String
  metadata Json?

  readAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([rfpId])
}

model NotificationPreference {
  id           String  @id @default(cuid())
  userId       String  @unique
  emailEnabled Boolean @default(true)
  inAppEnabled Boolean @default(true)

  // Buyer-specific toggles
  buyerRfpTimeline       Boolean @default(true)
  buyerSupplierResponses Boolean @default(true)
  buyerSupplierQuestions Boolean @default(true)
  buyerQABroadcasts      Boolean @default(true)
  buyerReadinessChanges  Boolean @default(true)

  // Supplier-specific toggles
  supplierQATimeline         Boolean @default(true)
  supplierSubmissionTimeline Boolean @default(true)
  supplierBroadcasts         Boolean @default(true)
  supplierResponseStatus     Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// STEP 23: Activity Log & Audit Trail System
model ActivityLog {
  id String @id @default(cuid())

  rfpId              String?
  supplierResponseId String?
  supplierContactId  String?
  userId             String?
  actorRole          String // "BUYER" | "SUPPLIER" | "SYSTEM"

  eventType String // event name
  summary   String // short human-readable summary
  details   Json? // structured metadata
  ipAddress String?
  userAgent String?
  isDemo    Boolean @default(false)

  createdAt DateTime @default(now())

  rfp              RFP?              @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  supplierResponse SupplierResponse? @relation(fields: [supplierResponseId], references: [id], onDelete: Cascade)
  supplierContact  SupplierContact?  @relation(fields: [supplierContactId], references: [id], onDelete: Cascade)
  user             User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Note: PostgreSQL full-text search implemented via case-insensitive contains queries

  @@index([rfpId, createdAt])
  @@index([userId, createdAt])
  @@index([eventType])
  @@index([actorRole])
  @@index([createdAt])
}


// STEP 38A: RFP Template System
model RfpTemplateCategory {
  id          String        @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  templates   RfpTemplate[]
}

model RfpTemplate {
  id            String                @id @default(cuid())
  categoryId    String
  category      RfpTemplateCategory   @relation(fields: [categoryId], references: [id])
  title         String
  description   String?
  structureJson Json                  // Full RFP template structure with sections, subsections, questions
  version       Int                   @default(1)
  isActive      Boolean               @default(true)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  
  rfps          RFP[]                 // RFPs that used this template
  
  @@index([categoryId])
  @@index([isActive])
}
