generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("buyer")  // "buyer" or "supplier"
  createdAt DateTime @default(now())
  rfps      RFP[]
  contacts  Contact[]
  supplierPortalAccess SupplierContact?
}

model Company {
  id        String   @id @default(uuid())
  name      String
  description String?
  createdAt DateTime @default(now())
  rfps      RFP[]
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  contactEmail String?
  createdAt DateTime @default(now())
  rfps      RFP[]
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum RFPStage {
  INTAKE
  QUALIFICATION
  DISCOVERY
  DRAFTING
  PRICING_LEGAL_REVIEW
  EXEC_REVIEW
  SUBMISSION
  DEBRIEF
  ARCHIVED
}

enum InvitationStatus {
  PENDING
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

model RFP {
  id               String    @id @default(uuid())
  title            String
  description      String?
  status           String    @default("draft")
  stage            RFPStage  @default(INTAKE)
  createdAt        DateTime  @default(now())
  dueDate          DateTime?
  submittedAt      DateTime?
  budget           Float?
  priority         Priority  @default(MEDIUM)
  internalNotes    String?
  stageEnteredAt   DateTime?
  enteredStageAt   DateTime?  // NEW: Primary field for SLA tracking
  stageSlaDays     Int?       // NEW: SLA duration for current stage
  stageAutoActions Json?
  
  // Opportunity Scoring (STEP 13)
  opportunityScore               Int?
  opportunityScoreBreakdown      Json?
  opportunityScoreUpdatedAt      DateTime?
  opportunityScoreSource         String?
  opportunityScoreOverrideReason String?
  
  // RFP Timeline & Milestones (STEP 14)
  askQuestionsStart   DateTime?
  askQuestionsEnd     DateTime?
  submissionStart     DateTime?
  submissionEnd       DateTime?
  demoWindowStart     DateTime?
  demoWindowEnd       DateTime?
  awardDate           DateTime?
  notifications       Json?
  
  user             User      @relation(fields: [userId], references: [id])
  userId           String
  company          Company   @relation(fields: [companyId], references: [id])
  companyId        String
  supplier         Supplier  @relation(fields: [supplierId], references: [id])
  supplierId       String
  summaryShares    SummaryShare[]
  stageHistory     StageHistory[]
  stageTasks       StageTask[]
  supplierContacts SupplierContact[]
  supplierResponses SupplierResponse[]
}

model Contact {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  email     String
  role      String?
  createdAt DateTime @default(now())
  shares    SummaryShare[]

  @@index([userId])
}

model SummaryShare {
  id          String   @id @default(uuid())
  rfpId       String
  rfp         RFP      @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  email       String
  template    String
  sentAt      DateTime @default(now())

  @@index([rfpId])
  @@index([contactId])
}

model StageHistory {
  id             String    @id @default(uuid())
  rfpId          String
  oldStage       RFPStage?
  newStage       RFPStage
  changedBy      String?
  overrideReason String?
  createdAt      DateTime  @default(now())
  
  rfp            RFP       @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  
  @@index([rfpId])
}

model StageTask {
  id          String    @id @default(uuid())
  rfpId       String
  stage       RFPStage
  title       String
  completed   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  completedAt DateTime?
  
  rfp         RFP       @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  
  @@index([rfpId])
  @@index([stage])
}

model SupplierContact {
  id               String           @id @default(uuid())
  rfpId            String
  name             String
  email            String
  organization     String?
  invitedAt        DateTime?
  invitationStatus InvitationStatus @default(PENDING)
  portalUserId     String?          @unique
  accessToken      String?
  accessTokenExpires DateTime?
  responses        Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  rfp              RFP              @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  portalUser       User?            @relation(fields: [portalUserId], references: [id], onDelete: SetNull)
  supplierResponse SupplierResponse?
  
  @@index([rfpId])
  @@index([email, rfpId])
}

enum SupplierResponseStatus {
  DRAFT
  SUBMITTED
}

enum AttachmentType {
  GENERAL
  PRICING_SHEET
  REQUIREMENTS_MATRIX
  PRESENTATION
  DEMO_RECORDING
  CONTRACT_DRAFT
  OTHER
}

model SupplierResponse {
  id                 String          @id @default(uuid())
  rfpId              String
  supplierContactId  String          @unique
  status             SupplierResponseStatus @default(DRAFT)
  submittedAt        DateTime?
  structuredAnswers  Json?
  notesFromSupplier  String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // AI Extraction Fields (STEP 17)
  extractedPricing              Json?
  extractedRequirementsCoverage Json?
  extractedTechnicalClaims      Json?
  extractedAssumptions          Json?
  extractedRisks                Json?
  extractedDifferentiators      Json?
  extractedDemoSummary          Json?
  extractedFilesMetadata        Json?

  rfp                RFP             @relation(fields: [rfpId], references: [id], onDelete: Cascade)
  supplierContact    SupplierContact @relation(fields: [supplierContactId], references: [id], onDelete: Cascade)
  attachments        SupplierResponseAttachment[]

  @@index([rfpId])
  @@index([supplierContactId])
  @@unique([rfpId, supplierContactId])
}

model SupplierResponseAttachment {
  id                 String   @id @default(uuid())
  supplierResponseId String
  fileName           String
  fileType           String
  fileSize           Int
  storageKey         String
  attachmentType     AttachmentType @default(GENERAL)
  description        String?
  createdAt          DateTime @default(now())

  supplierResponse   SupplierResponse @relation(fields: [supplierResponseId], references: [id], onDelete: Cascade)

  @@index([supplierResponseId])
}